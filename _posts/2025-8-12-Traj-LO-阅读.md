---
title: "SLAM 算法阅读记录：Traj-LO"
date: 2025-08-12 
categories: [SLAM算法梳理]
tags: [Traj-LO]
---
- 纯雷达slam，类似ct-icp的连续时间思想
- **项目地址**：[https://github.com/kevin2431/Traj-LO](https://github.com/kevin2431/Traj-LO)  

---
# 1. 论文阅读
## 概念定义

---

### 基本概念

- **$SE(3)$**：特殊欧几里得群，表示三维空间中的刚体变换（旋转 + 平移）。  
  - 一个元素 $T \in SE(3)$ 是一个 $4 \times 4$ 的变换矩阵：
    $$
    T = \begin{bmatrix} R & t \\ 0 & 1 \end{bmatrix}, \quad R \in SO(3),\ t \in \mathbb{R}^3
    $$

- **$se(3)$**：$SE(3)$ 的切空间（tangent space），也叫李代数。  
  - 一个向量 $\tau \in \mathbb{R}^6$ 通常包含旋转部分（3维）和平移部分（3维）。  

- **右加号 $\oplus$ 和右减号 $\ominus$**：用于在 $SE(3)$ 和 $se(3)$ 之间做加减运算。

- **增量操作（$\oplus$）**：把 $se(3)$ 向量加到变换矩阵上：
  $$
  T \oplus \tau = T \, \mathrm{Exp}(\tau)
  $$  
  - $\mathrm{Exp}(\tau)$ 将 $se(3)$ 向量映射到 $SE(3)$（类似指数映射）。
  - 理解为："在已有位姿 $T$ 的基础上，沿 $\tau$ 方向移动/旋转"。

- **差分操作（$\ominus$）**：计算两个 $SE(3)$ 变换的差异：
  $$
  T_1 \ominus T_2 = \mathrm{Log}(T_2^{-1} T_1)
  $$  
  - $\mathrm{Log}: SE(3) \to se(3)$ 是对数映射，把变换矩阵转换为向量形式。
  - 理解为："从 $T_2$ 到 $T_1$ 的最小位姿增量"。

- $\mathrm{Exp}: \mathbb{R}^6 \to SE(3)$  
  - 将 6 维向量（旋转 + 平移）变为 4x4 变换矩阵。  

- $\mathrm{Log}: SE(3) \to \mathbb{R}^6$  
  - 将 变换矩阵 变回 6 维向量。  

- **优势**：
  - 避免奇异性（singularity），比如欧拉角容易产生万向节锁，而李代数表示不会有这个问题。  

---

### 总结理解

- $\tau \in se(3)$ 是"增量向量"，$T \in SE(3)$ 是"当前位姿"。  
- $\oplus$ 把向量"加"到位姿上得到新的位姿。  
- $\ominus$ 计算两个位姿之间的增量向量。  
- Exp 和 Log 是在矩阵和向量之间的桥梁。  

---
## 参数化轨迹

为了应对快速运动，作者将时间窗口 $[t_0, t_K)$ 划分为 $K$ 个等距的小段 $\{[t_{k-1}, t_k)\}_{k=1}^{K}$，在每个小段内仍使用 **两个控制位姿**（初始 $T_{k-1}$ 和结束 $T_k$）对运动进行参数化。连续时间轨迹在第 $k$ 段 $[t_{k-1}, t_k)$ 内表示为函数 $\phi_k(t)$，对于时间戳为 $t_i$ 的测量点，其对应的 LiDAR 位姿为  
$$
T_{t_i} = \phi_k(t_i) = T_{k-1} \oplus (\alpha_i \tau^k), \quad \alpha_i = \frac{t_i - t_{k-1}}{\Delta t_k}, \quad \tau^k = T_k \ominus T_{k-1}
$$  
其中每段长度 $\Delta t_k = t_k - t_{k-1}$ 是一个根据运动特性设定的超参数。


### 线性插值在轨迹估计中的应用及局限性

- **目标**：在时间窗口 $[t_0, t_K)$ 内估计物体的运动轨迹。  
- **最简单方法**：**线性插值（linear interpolation）**。  
  - 用 **起始位姿 $T_0$** 和 **结束位姿 $T_K$** 表示整个时间段的运动。  
  - 公式表示：
    $$
    T(t) = (1-\alpha) T_0 + \alpha T_K, \quad \alpha = \frac{t-t_0}{t_K-t_0}
    $$

---

### 线性插值的问题

- **局限性**：  
  - 对于剧烈运动（如手持设备快速移动或无人机飞行），线性插值无法准确描述轨迹。  
  - 实际运动可能有快速转弯、加速或非线性变化，线性模型太粗糙。  

- **小时间间隔的影响**：
  - 当 $(t_K - t_0) \to 0$ 时，运动接近线性，线性插值效果较好。  
  - 但时间窗口太短 → 可用观测点少 → **约束不足（under-constrained）**，难以完成位姿配准（registration）。

| 时间窗口 | 优势 | 问题 |
|----------|------|------|
| 长 | 数据点多，约束充分 | 线性插值不准确，运动非线性显现 |
| 短 | 运动接近线性，插值精度高 | 数据点少，可能导致估计不稳定 |

---

### 总结

- 线性插值适合 **短时间平滑运动**。  
- 对于 **快速、非线性运动**，需要更复杂的插值方法（如 B 样条）来提高精度。  
- 作者提出了一个 **简单但有效的方案**，在轨迹精度和数据约束之间取得平衡。

---

## 基于连续时间轨迹的 LiDAR 里程计方法

作者提出了一种利用连续时间轨迹参数化的 LiDAR 里程计方法（如 Fig. 3 所示）。为了满足实时性，该方法采用**滑动窗口**（sliding window）策略，在每个时间窗口中包含三个主要模块：**连续时间配准（continuous-time registration）**、**运动学约束（kinematic constraint）** 和 **边缘化（marginalization）**。为了推导 LiDAR 里程计的概率公式，作者引入了控制输入 $u(t)$ 以及由历史 LiDAR 点构成的地图 $M = \{q_m\}_{m=1}^M$，其中每个地图点 $q_m$ 都定义在世界坐标系下。连续时间变量 $u(t)$ 会影响系统的运动动力学，而地图 $M$ 则由当前时间窗口之前的 LiDAR 点构建。轨迹 $T(t)$ 在区间 $[t_0, t_K)$ 内的估计依赖于一系列 LiDAR 测量值 $Z$，目标是在该时间段内最大化联合后验概率 $p(T(t) \mid u(t), M, Z)$。

由于在给定 $T(t)$ 的情况下，控制输入 $u(t)$ 不会直接影响 LiDAR 的观测 $Z$，作者利用贝叶斯公式将后验重写为：
$$
p(T(t) \mid u(t), M, Z) \propto p(Z \mid T(t), M) \cdot p(T(t) \mid u(t))
$$
其中，$p(Z \mid T(t), M)$ 是给定轨迹和地图时观测数据的似然函数，反映了配准误差；$p(T(t) \mid u(t))$ 则体现了由控制输入引入的运动学先验约束。

### 连续时间约束
- 将雷达测量分为$K$个集合，每个集合由点的坐标和对应的时间戳组成$\{P_i^j, t_i^j\}$,

在本方法中，每个 LiDAR 相对于参考坐标系的外参由 $T_{LB_j}$ 表示，这些外参参数在系统运行前已完成标定，并在整个优化过程中保持固定。假设所有观测相互独立，则似然项 $p(Z \mid T(t), M)$ 可以分解为：
$$
p(Z \mid T(t), M) = \prod_{k=1}^K \prod_{j=1}^J \prod_{i=1}^{N_j} p\left(\{ {}^k p^j_i, {}^k t^j_i \} \,\middle|\, T({}^k t^j_i), M \right)
$$
其中：
- $k$ 表示时间段索引，
- $j$ 表示 LiDAR 传感器编号，
- $i$ 表示该传感器在该时间段内的点索引，
- ${}^k p^j_i$ 为点的三维坐标，${}^k t^j_i$ 为该点的时间戳。
- 似然函数表示在已知轨迹 $T(t)$ 和地图 $M$ 的情况下，观测数据 $Z$出现的概率。反映了模型和观测匹配的程度：如果轨迹和地图对得很准（配准误差小），似然值就大；如果配准误差大，似然值就小。在这里，似然函数由**所有点的观测误差**的概率密度相乘得到 $\prod_{k,j,i} p(\text{该点的观测} \mid T(t),M)$

对于点 ${}^k z^j_i$，几何误差（点到平面的距离）定义为：
$$
e^k_{z^j_i} = n^k_{j_i} \cdot \left( \phi_k({}^k t^j_i) \cdot T_{LB_j} \cdot {}^k p^j_i - {}^k q^j_i \right)
$$
其中：
- $\phi_k({}^k t^j_i)$ 由公式 (1) 计算，表示参考坐标系在时间 ${}^k t^j_i$ 的位姿；
- ${}^k q^j_i$ 是地图 $M$ 中距离该点最近的邻居点；
- $n^k_{j_i}$ 是法向量，通过 PCA 在地图中选取最近的 5 个邻居点计算获得（与 [7], [10] 类似）。

理想情况下，点到平面的距离应接近零。假设该误差服从高斯分布 $e^k_{z^j_i} \sim \mathcal{N}(0, Q_r)$，则该观测的概率模型为：
$$
p\left(\{{}^k p^j_i, {}^k t^j_i\} \mid T({}^k t^j_i), M\right) = \mathcal{N}\left(e^k_{z^j_i}, Q_r\right)
$$
这为后续基于概率的优化提供了量化的误差模型。这个分布是**概率建模版本**的点到面的icp解释

#### 传统icp
- 给定当前点云和已有地图，找到每个点的最近邻（对应关系）。定义一个误差度量（这里用点到平面距离）。通过优化位姿，使得所有点的误差平方和最小。目标函数 $\min_i \sum (n_i ({T_p}_i-q_i))^2$
#### 概率版本的解释
- 观测关系：点到平面
- 理想值：0
- 实际值: $e_{kz_i^j}$ （由位姿预测 + 实际测量得到）
- 噪声假设：零均值高斯
- 概率公式：$p(\text{观测} \mid T) = \mathcal{N}(e_{kz_i^j},Q_r)$

传统 ICP 是确定性优化（直接最小化平方误差）。
概率 ICP（也叫 概率配准）把误差看作随机变量，给它一个统计分布（高斯分布是常见选择）。
这样做的好处：
- 可以自然结合其他概率约束（比如运动学先验）。
- 可以处理不同类型观测的噪声（通过不同的协方差矩阵）。
- 优化问题转化为最大似然估计，和 SLAM 中的 BA/Graph Optimization 框架统一。



### 运动约束（轨迹平滑性）

在连续时间 LiDAR 里程计中，如果只依赖点云几何匹配，容易在剧烈运动时收敛困难，因此作者引入**不依赖 IMU 的运动学约束**，通过轨迹平滑性来稳定优化。具体做法是：将时间窗口分成多个小段 $[t_{k-1}, t_k)$，在每段内假设速度恒定，并定义广义速度 $\kappa(t) = \frac{T_k \ominus T_{k-1}}{\Delta_k}$，其中 $\ominus$ 表示两个位姿的相对变换，$\Delta_k$ 是时间段长度。由于真实运动应当平滑，相邻两段的速度差应接近零，因此引入上一滑动窗口优化得到的固定速度 $\hat{\kappa} = \frac{\hat{T}_{k-1} \ominus \hat{T}_{k-2}}{\Delta_{k-1}}$，并定义平滑性误差 $e^v_k = (T_k \ominus T_{k-1}) - (\hat{T}_{k-1} \ominus \hat{T}_{k-2})$。

该误差假设服从零均值高斯分布 $e^v_k \sim \mathcal{N}(0, Q_v)$，于是平滑性约束的概率表达为 $p(T(t) \mid u(t)) = \prod_{k=1}^K p(\phi_k(t), u_k(t))$，且 $p(\phi_k(t), u_k(t)) = \mathcal{N}(e^v_k, Q_v)$。直观地说，这个约束像在优化中加了一个"速度阻尼器"，防止轨迹速度突变，让估计结果更加稳定和平滑。

### 联合优化

作者的目标是在时间窗口 $[t_0, t_K)$ 内，根据 $K+1$ 个控制位姿 $\{T_k\}_{k=0}^K$ 来求得最优的**连续时间轨迹** $T(t)$。优化的思想是最大化后验概率 $p(T(t) \mid u(t), M, Z)$，等价于最小化它的负对数：

$$
\{T_k^*\}_{k=0}^K = \arg\min_{T(t)} \left( -\log p(T(t) \mid u(t), M, Z) \right)
$$

由于之前假设几何误差和平滑性误差都是**高斯分布**，这个优化可以转化为**非线性最小二乘问题**，即最小化能量函数：

$$
\{T_k^*\}_{k=0}^K = \arg\min_{T(t)} E_{\text{reg}} + E_{\text{kine}} + E_{\text{marg}}
$$

其中：

* $E_{\text{reg}}$：几何配准能量，由所有点到平面的误差 $e^z_{kji}$ 计算，形式是**加权平方和**（权重为协方差矩阵 $Q_r^{-1}$）， $e^TQ^{-1}e$；
* $E_{\text{kine}}$：轨迹平滑性能量，由速度差误差 $e^v_k$ 计算，权重为 $Q_v^{-1}$；
* $E_{\text{marg}}$：边缘化能量，来源于滑动窗口优化，将旧状态的约束保留在优化中。

简单来说，这个过程就是**把几何约束 + 平滑性约束 + 历史约束放在一起，用非线性最小二乘同时优化所有控制位姿**，从而得到既符合几何观测、又平滑、又与历史一致的连续时间轨迹。

### 边缘化

## �� Marginalization（边缘化）

为了保证实时性能，算法在优化时**只保留固定数量 $K$ 个时间段**（segments）在滑动窗口中。当新的段 $\phi_{K+1}(t)$ 加入时，最老的段 $\phi_1(t)$ 会被移出窗口。
但是，这些段的时间间隔通常比一次 LiDAR 扫描的持续时间还短，所以同一滑动窗口中的 $K$ 段可能来自不同的扫描帧。
如果简单丢掉 $[t_0, t_1)$ 时间段的测量信息，会损失对轨迹估计有用的约束，因此作者引入**边缘化先验（Marginalization Prior）**来保留这些信息。

边缘化的过程是在**旧窗口优化收敛后**，根据只与被边缘化变量相关的能量项，通过**舒尔补（Schur Complement）**计算得到边缘化先验的**Hessian 矩阵 $H_m$** 和 **残差向量 $b_m$**。新窗口中的控制位姿 $\mathbf{s}$ 会分成两部分：

* $s_m$：与被边缘化变量相关的部分（需要保留先验约束）
* $s_n$：与被边缘化变量无关的部分

边缘化能量表示为：

$$
E_m = \frac{1}{2} (\mathbf{s}_m - \bar{\mathbf{s}}_m)^T H_m (\mathbf{s}_m - \bar{\mathbf{s}}_m) + b_m^T (\mathbf{s}_m - \bar{\mathbf{s}}_m)
$$

其中 $\bar{\mathbf{s}}_m$ 是应用舒尔补时的固定**线性化点**。

在本文的轨迹表示中，段 $\phi_1(t)$ 依赖两个控制位姿 $T_0$ 和 $T_1$。当移除 $\phi_1(t)$ 时，$T_0$ 会被删除，但 $T_1$ 仍在下一个段 $\phi_2(t)$ 中使用，因此 $T_1$ 会被保留，并出现在新的窗口 $s_m$ 中，继承旧窗口的先验约束。
此外，作者使用**First-Estimate Jacobian (FEJ)** 技术，确保边缘化后的系统在优化时保持一致性，即对于与先验相关的位姿，其雅可比矩阵在最初的线性化点处固定不变。


## 推导雅可比公式
之前的优化  
$$
\{T_k^*\}_{k=0}^K = \arg\min_{T(t)} E_{\text{reg}} + E_{\text{kine}} + E_{\text{marg}}
$$ 
作者采用牛顿高斯优化

## Gauss-Newton 优化与雅可比矩阵推导

在这部分，作者描述了如何利用 **Gauss-Newton 方法** 求解前面提出的非线性最小二乘问题（公式 (8)）。核心思想是将误差函数在当前线性化点 $s$ 附近做**一阶泰勒展开**：

$$
e(s \oplus \xi) \approx e(s) + \frac{\partial e}{\partial s} \xi
$$

* 这里 $s = [T_0, \dots, T_K]$ 是连续轨迹的 $K+1$ 个控制位姿堆叠向量。
* $\xi \in \mathbb{R}^{6(K+1)}$ 是每个位姿的小增量。
* $\frac{\partial e}{\partial s}$ 是误差项对控制位姿的雅可比矩阵。

利用 Gauss-Newton，最优增量 $\xi$ 通过解**正规方程**得到：

$$
H \xi = -b, \quad H = \sum \left(\frac{\partial e}{\partial s}\right)^T W^{-1} \frac{\partial e}{\partial s}, \quad b = \sum \left(\frac{\partial e}{\partial s}\right)^T W^{-1} e
$$

* $W$ 是对应的协方差矩阵。
* 更新规则为 $T_k \leftarrow T_k \oplus \xi_k$，即用增量更新每个控制位姿。

### 雅可比矩阵推导

## Gauss-Newton 优化与雅可比矩阵推导

在这部分，作者描述了如何利用 **Gauss-Newton 方法** 求解前面提出的非线性最小二乘问题（公式 (8)）。核心思想是将误差函数在当前线性化点 $s$ 附近做**一阶泰勒展开**：

$$
e(s \oplus \xi) \approx e(s) + \frac{\partial e}{\partial s} \xi
$$

* 这里 $s = [T_0, \dots, T_K]$ 是连续轨迹的 $K+1$ 个控制位姿堆叠向量。
* $\xi \in \mathbb{R}^{6(K+1)}$ 是每个位姿的小增量。
* $\frac{\partial e}{\partial s}$ 是误差项对控制位姿的雅可比矩阵。

利用 Gauss-Newton，最优增量 $\xi$ 通过解**正规方程**得到：

$$
H \xi = -b, \quad H = \sum \left(\frac{\partial e}{\partial s}\right)^T W^{-1} \frac{\partial e}{\partial s}, \quad b = \sum \left(\frac{\partial e}{\partial s}\right)^T W^{-1} e
$$

* $W$ 是对应的协方差矩阵。
* 更新规则为 $T_k \leftarrow T_k \oplus \xi_k$，即用增量更新每个控制位姿。

### 雅可比矩阵推导

为了加速优化，作者使用**解析雅可比**而非自动微分。由于每个误差项只与少数几个控制位姿相关，因此可以局部计算雅可比。

对连续时间注册误差项 $e^{k}_{z^j_i}$ 的雅可比形式为：

$$
\frac{\partial e^{k}_{z^j_i}}{\partial s} = \frac{\partial e^{k}_{z^j_i}}{\partial \phi_k(k t^j_i)} \left[ \frac{\partial \phi_k(k t^j_i)}{\partial T_{k-1}} \quad \frac{\partial \phi_k(k t^j_i)}{\partial T_k} \right]
$$

其中：

$$
\frac{\partial e^{k}_{z^j_i}}{\partial \phi_k(k t^j_i)} = \mathbf{n}^{k j}_i \left[ R_{k t^j_i} - R_{k t^j_i} [TLB_j \, p^k_j_i]_\times \right]
$$

$$
\frac{\partial \phi_k(k t^j_i)}{\partial T_{k-1}} = (1-\alpha^k_j_i) J_r((\alpha^k_j_i-1) \tau_k) J_l^{-1}(\tau_k), \quad
\frac{\partial \phi_k(k t^j_i)}{\partial T_k} = \alpha^k_j_i J_r(\alpha^k_j_i \tau_k) J_r^{-1}(\tau_k)
$$

* $R_{k t^j_i}$ 是参考位姿的旋转部分。
* $[\,\cdot\,]_\times$ 是反对称矩阵。
* $J_r$ 和 $J_l$ 分别是 SE(3) 的右/左雅可比矩阵。

对于轨迹平滑约束（运动学约束），雅可比为：

$$
\frac{\partial e^{v}_k}{\partial T_{k-1}} = -J_l^{-1}(\tau_k), \quad \frac{\partial e^{v}_k}{\partial T_k} = J_r^{-1}(\tau_k)
$$



- 这一部分的核心思想是：通过**一阶线性化**误差函数，构建正规方程并解析计算雅可比，从而迭代更新每个连续轨迹的控制位姿，实现非线性最小二乘的高效求解。




# 2. 整体架构

数据输入 → 数据加载器 → 激光雷达里程计 → 可视化器 → 输出结果

时间轴 →  



# 2. 核心函数：Traj-LO/src/core/odometry.cpp/void TrajLOdometry::Start() 函数

<details>
<summary>cmakelists.txt（点击展开/收起）</summary>


</details>
