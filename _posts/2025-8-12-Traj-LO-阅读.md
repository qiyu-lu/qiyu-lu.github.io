---
title: "SLAM 算法阅读记录：Traj-LO"
date: 2025-08-12 
categories: [SLAM算法梳理]
tags: [Traj-LO]
---
- 纯雷达slam，类似ct-icp的连续时间思想
- **项目地址**：[https://github.com/kevin2431/Traj-LO](https://github.com/kevin2431/Traj-LO)  

---
# 1. 论文阅读
## 概念定义


## 雅可比矩阵推导
你的理解对了！在高斯-牛顿框架下，线性化得到

$E \approx (e + J\xi)^{\!\top} W^{-1} (e + J\xi)$

，并形成正规方程$H\xi=-b$，其中 \(H=J^{\!\top}W^{-1}J\)，\(b=J^{\!\top}W^{-1}e\)。
**根据这几个式子，我们要求的是增量向量 \(\xi\)**（把所有控制位姿的 6D 增量堆叠而成，维度是 \(6(K+1)\)）。步骤是：
1) 用当前线性化点 \(s=[T_0,\dots,T_K]\) 计算误差 \(e\) 与雅可比 \(J\)，装配 \(H,b\)；
2) 解线性方程 \(H\xi=-b\)（通常用稀疏 Cholesky/PCG；若 \(H\) 近奇异，会用 LM 衰减 \(H+\lambda I\)）；
3) 将各块增量分发到位姿：\(T_k \leftarrow T_k \oplus \xi_k\)；
4) 迭代重复直至收敛（\(\|\xi\|\) 很小或目标下降很小）。

**能得到的结果：**
- 直接解出本次迭代的**最优增量 \(\xi\)**；
- 由此更新得到一组更优的**控制位姿 \(\{T_k\}\)**；
- 迭代收敛后得到整个时间窗内的**连续时间轨迹 \(T(t)\)** 的最优解（在当前数据与先验下的局部极小）。
同时，\(H\) 体现了问题的二阶近似（信息矩阵/曲率），其稀疏块结构对应“每个误差只连少量位姿”的性质，有助于高效求解。

# Gauss–Newton 与连续时间配准项的雅可比推导（含 9a–9d, 10）
> 本文档可直接放入基于 Jekyll 的博客中，使用 MathJax 渲染公式。

我们关注的配准误差为（点到平面）：
\[
e \;\triangleq\; \mathbf{n}^\top \Big(\, \phi_k(t_i)\,T_{LB_j}\,\mathbf{p} \;-\; \mathbf{q} \,\Big),
\]
其中 \(\mathbf{n}\) 为地图局部平面法向量，\(\mathbf{p}\) 是 LiDAR\(j\) 坐标系下的原始点，\(\mathbf{q}\) 是地图中最近邻点（世界系），\(T_{LB_j}\) 为 LiDAR\(j\)\(\to\)参考系外参，\(\phi_k(t)\) 是第 \(k\) 段的连续时间位姿。第 \(k\) 段内的轨迹参数化为
\[
\phi_k(t) \;=\; T_{k-1}\;\Exp\!\big(\alpha\,\tau^k\big),\qquad
\tau^k \;=\; \Log\!\big(T_{k-1}^{-1}T_k\big),\quad
\alpha=\tfrac{t-t_{k-1}}{\Delta t_k}.
\]

---

### 9a：链式法则的结构
误差只与当前所在段的两个控制位姿 \(T_{k-1},T_k\) 有关，因此对整堆状态 \(s=[T_0,\dots,T_K]\) 的导数呈块稀疏形式。对任意线性化点 \(s\) 的右扰动 \(s\oplus\xi\) 做一阶展开
\[
e(s\oplus\xi)\;\approx\; e(s)\;+\;\frac{\partial e}{\partial s}\,\xi,
\]
其中
\[
\boxed{\;
\frac{\partial e}{\partial s}
\;=\;
\frac{\partial e}{\partial \phi_k(t_i)}
\;\Big[\;
\frac{\partial \phi_k(t_i)}{\partial T_{k-1}}
\quad
\frac{\partial \phi_k(t_i)}{\partial T_k}
\;\Big]
\;}
\tag{9a}
\]
这就是文中的 9a：先对中间量 \(\phi_k(t_i)\) 求导（“几何项”），再乘上 \(\phi_k\) 对端点位姿的导数（“插值项”）。

---

### 9b：\(\displaystyle \frac{\partial e}{\partial \phi_k(t_i)}\) 的推导（几何项）
令
\[
\mathbf{X}\;\triangleq\; T_{LB_j}\,\mathbf{p}, \qquad
\phi_k(t_i)\;=\;\begin{bmatrix}R & \mathbf{t}\\ \mathbf{0}^\top & 1\end{bmatrix},
\qquad
\mathbf{x} \;\triangleq\; R\,\mathbf{X}+\mathbf{t},
\]
则
\[
e \;=\; \mathbf{n}^\top(\mathbf{x}-\mathbf{q}) \;=\; \mathbf{n}^\top(R\,\mathbf{X}+\mathbf{t}-\mathbf{q}).
\]
对位姿采用**右扰动** \(\phi \mapsto \phi\Exp(\boldsymbol{\xi})\)，其中 \(\boldsymbol{\xi}=[\boldsymbol{\rho};\boldsymbol{\theta}]\in\mathbb{R}^6\)（先平移后旋转的右平凡化），有一阶近似：
\[
\delta \mathbf{x}
=
\underbrace{R}_{3\times3}\,\boldsymbol{\rho}
\;-\;
\underbrace{R[\mathbf{X}]_\times}_{3\times3}\,\boldsymbol{\theta},
\quad
[\cdot]_\times \text{ 为反对称矩阵}.
\]
因此
\[
\delta e
=
\mathbf{n}^\top\,\delta \mathbf{x}
=
\mathbf{n}^\top\Big( R\,\boldsymbol{\rho} - R[\mathbf{X}]_\times \boldsymbol{\theta}\Big)
=
\underbrace{\mathbf{n}^\top\!\Big[\; R \;\; -R[\mathbf{X}]_\times \;\Big]}_{1\times 6}
\begin{bmatrix}\boldsymbol{\rho}\\ \boldsymbol{\theta}\end{bmatrix}.
\]
于是得到
\[
\boxed{\;
\frac{\partial e}{\partial \phi_k(t_i)}
\;=\;
\mathbf{n}^\top\!\Big[\; R \;\; -R\,[T_{LB_j}\mathbf{p}]_\times \;\Big]
\;}
\tag{9b}
\]
与文中写法一致（他们将 \(\mathbf{n}\) 记作 \(k n_i^j\)，并用 \(R_{k t_i^j}\) 指代 \(R\)）。

---

### 9c / 9d：\(\displaystyle \frac{\partial \phi_k(t_i)}{\partial T_{k-1}},\;\frac{\partial \phi_k(t_i)}{\partial T_k}\) 的推导（插值项）
记
\[
\phi_k(t)
=
T_{k-1}\;\Exp(\alpha\,\tau),\qquad \tau=\Log(T_{k-1}^{-1}T_k).
\]
对右扰动 \(\delta T_{k-1}=T_{k-1}\Exp(\boldsymbol{\xi}_{k-1})\)、\(\delta T_k=T_k\Exp(\boldsymbol{\xi}_k)\) 求 \(\delta\phi\) 的一阶变化。需要三条李群/李代数恒等式（右/左雅可比参见 [33]）：

1. **指数映射的右雅可比微分**（在右平凡化下）  
   \[
   \delta\Exp(\alpha\tau)
   \;\approx\;
   \Exp(\alpha\tau)\;\Jr(\alpha\tau)\,\alpha\,\delta\tau.
   \]
2. **相对位姿的对数微分**  
   \[
   \delta\tau
   \;\approx\;
   \Jl(\tau)^{-1}\big(\,\boldsymbol{\xi}_k \;-\; \boldsymbol{\xi}_{k-1}\,\big).
   \]
   > 这是 \(\tau=\Log(T_{k-1}^{-1}T_k)\) 在**右扰动**下的标准一阶近似：前后端点的右扰动在切空间中以 \(\Jl(\tau)^{-1}\) 规整。
3. **左乘的扰动传播**  
   \[
   \delta\phi
   \;=\;
   \underbrace{T_{k-1}\Exp(\alpha\tau)}_{\phi}\,\boldsymbol{\xi}_{k-1}
   \;+\;
   T_{k-1}\,\delta\Exp(\alpha\tau).
   \]

把 1–3 代入并收集 \(\boldsymbol{\xi}_{k-1}\)、\(\boldsymbol{\xi}_{k}\) 的系数，可写成右平凡化的增量映射
\[
\delta\phi
\;\equiv\;
\phi\,\Big(
(1-\alpha)\,\Jr\!\big((\alpha-1)\tau\big)\,\Jl(\tau)^{-1}\,\boldsymbol{\xi}_{k-1}
\;+\;
\alpha\,\Jr(\alpha\tau)\,\Jr(\tau)^{-1}\,\boldsymbol{\xi}_{k}
\Big),
\]
从而得到对端点位姿的“右雅可比”（去掉前面的 \(\phi\) 左乘，因为后续会与 9b 的 \(\partial e/\partial\phi\) 相乘）：
\[
\boxed{\;
\frac{\partial \phi_k(t_i)}{\partial T_{k-1}}
=
(1-\alpha)\,\Jr\!\big((\alpha-1)\tau\big)\,\Jl(\tau)^{-1}
\;}
\tag{9c}
\]
\[
\boxed{\;
\frac{\partial \phi_k(t_i)}{\partial T_{k}}
=
\alpha\,\Jr(\alpha\tau)\,\Jr(\tau)^{-1}
\;}
\tag{9d}
\]
这与文中 9c、9d 完全一致。直观理解：\((1-\alpha)\) 与 \(\alpha\) 分别给出“靠近起点/终点”的权重，\(\Jr,\Jl\) 则负责把端点位姿的右扰动正确地搬运到中间时刻的 \(\phi_k(t_i)\) 上。

---

### 10：运动学（平滑性）约束的雅可比
平滑性误差定义为
\[
e^v_k \;=\; (T_k \ominus T_{k-1}) \;-\; \widehat{(T_{k-1}\ominus T_{k-2})}
\;=\; \tau^k \;-\; \hat{\tau}^{k-1},
\]
其中 \(\tau^k=\Log(T_{k-1}^{-1}T_k)\)，\(\hat{\tau}^{k-1}\) 为上个窗口固定先验。对端点右扰动求导（用上面的第 2 条恒等式）：
\[
\boxed{\;
\frac{\partial e^v_k}{\partial T_{k-1}} = -\,\Jl(\tau^k)^{-1},
\qquad
\frac{\partial e^v_k}{\partial T_{k}} \;=\; \Jr(\tau^k)^{-1}.
\;}
\tag{10}
\]
这与文中式 (10) 一致。

---

### 小结：9a–9d 如何拼成最终雅可比
- 先用 **9b** 得到几何项 \(\partial e/\partial\phi\)；
- 再用 **9c、9d** 把 \(\phi\) 对端点位姿的导数连锁到 \(\partial e/\partial T_{k-1},\partial e/\partial T_k\)；
- 将两者按 **9a** 链式相乘，装配到整堆状态 \(s\) 的雅可比行中（其他不相干位姿的列为零）。
这样即可形成稀疏的 \(J\)，进一步构造 \(H=J^\top W^{-1}J\)、\(b=J^\top W^{-1}e\)，进入 Gauss–Newton 的线性求解与迭代更新。


---
